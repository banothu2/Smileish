doctype html
html
	head
		title= title
		link(rel='stylesheet', href='/stylesheets/style.css')

		link(rel='stylesheet', href='http://assets.ziggeo.com/css/ziggeo-betajs-player.min.css')
		script(src='http://assets.ziggeo.com/js/ziggeo-jquery-json2-betajs-player.min.js')


		script(src='//code.jquery.com/jquery-1.11.2.min.js')
		// Latest compiled and minified CSS
		link(rel='stylesheet', href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css')
		// Optional theme
		link(rel='stylesheet', href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css')
		// Latest compiled and minified JavaScript
		script(src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js')
		link(href='stylesheets/page.css', rel='stylesheet')

		script.
			ZiggeoApi.token = "cadb6da3bc21c58a7cbe699685daf03d";

		style.
			video {

				background: rgba(255,255,255,0.5);
				border: 1px solid #ccc;
			}
			.grayscale {
				+filter: grayscale(1);
			}
			.sepia {
				+filter: sepia(1);
			}
			.blur {
				+filter: blur(3px);
			}

			html {
			position: relative;
			min-height: 100%;
			}
			div {
			color: white;
			}
			body {
			font: 10px sans-serif;
			shape-rendering: crispEdges;
			margin-bottom: 60px;
			background-color:#19B5FE;
			}
		script.

				function base64_decode(data) {
				//  discuss at: http://phpjs.org/functions/base64_decode/
				// original by: Tyler Akins (http://rumkin.com)
				// improved by: Thunder.m
				// improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
				// improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
				//    input by: Aman Gupta
				//    input by: Brett Zamir (http://brett-zamir.me)
				// bugfixed by: Onno Marsman
				// bugfixed by: Pellentesque Malesuada
				// bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
				//   example 1: base64_decode('S2V2aW4gdmFuIFpvbm5ldmVsZA==');
				//   returns 1: 'Kevin van Zonneveld'
				//   example 2: base64_decode('YQ===');
				//   returns 2: 'a'

				var b64 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';
				var o1, o2, o3, h1, h2, h3, h4, bits, i = 0,
				ac = 0,
				dec = '',
				tmp_arr = [];

				if (!data) {
				return data;
				}

				data += '';

				do { // unpack four hexets into three octets using index points in b64
				h1 = b64.indexOf(data.charAt(i++));
				h2 = b64.indexOf(data.charAt(i++));
				h3 = b64.indexOf(data.charAt(i++));
				h4 = b64.indexOf(data.charAt(i++));

				bits = h1 << 18 | h2 << 12 | h3 << 6 | h4;

				o1 = bits >> 16 & 0xff;
				o2 = bits >> 8 & 0xff;
				o3 = bits & 0xff;

				if (h3 == 64) {
				  tmp_arr[ac++] = String.fromCharCode(o1);
				} else if (h4 == 64) {
				  tmp_arr[ac++] = String.fromCharCode(o1, o2);
				} else {
				  tmp_arr[ac++] = String.fromCharCode(o1, o2, o3);
				}
				} while (i < data.length);

				dec = tmp_arr.join('');

				return dec.replace(/\0+$/, '');
				}


				window.addEventListener('DOMContentLoaded', function() {
					var v = document.getElementById('v');
					navigator.getUserMedia = (navigator.getUserMedia || 
						navigator.webkitGetUserMedia || 
						navigator.mozGetUserMedia || 
						navigator.msGetUserMedia);
					if (navigator.getUserMedia) {
						// Request access to video only
					}
					else {
					alert('Sorry, the browser you are using doesn\'t support getUserMedia');
					return;
					}
				});

				var videoSource = '';

				function startUserMedia(){
						navigator.getUserMedia(
							{
								video:true,
								audio:false
							},        
							function(stream) {
								var url = window.URL || window.webkitURL;
								v.src = url ? url.createObjectURL(stream) : stream;
								videoSource = v.src;
								document.getElementById("videoURL").innerHTML = "<p>" + videoSource + "</p>";

								v.play();
							},
							function(error) {
								alert('Something went wrong. (error code ' + error.code + ')');
								return;
							}
						);
				}

				function snapshotGrab(){
				  var video = document.querySelector('#v');
				  var canvas = document.querySelector('canvas');
				  var ctx = canvas.getContext('2d');
				  var localMediaStream = null;
				  var canvasVal = '';
				  function snapshot() {
				    if (videoSource) {
				      ctx.drawImage(video, 0, 0, 640, 900, 0, 0, 300, 300);
				      // "image/webp" works in Chrome.
				      // Other browsers will fall back to image/png.
				      //console.log(canvas.toDataURL('image/webp'))
				      var dataURL = canvas.toDataURL();


				      canvasVal = canvas.toDataURL('image/png');
				      document.querySelector('img').src = canvas.toDataURL();
				    }
				  }
				  snapshot();
				  	if(canvasVal != ''){
				  		//- var mystring = "this/is/a/test"
						//- console.log(mystring.replace(/\//g , ":"));
				  		//- var removedStart = canvasVal.replace(/data:image\/png;base64,/, "");
				  		//- console.log(removedStart);

				  		//var convertedCanvas = removedStart.replace(/\//g, "COMPLEX");
				  		//var convertedCanvas2 = convertedCanvas.replace(/\+/g, "STATIC");

					 	//-  	$.get( "/api/base64/"+convertedCanvas2, function( data ) {
						//- 	  console.log(data);
						//- });
					}
				}



				// This code loads the IFrame Player API code asynchronously.
				var tag = document.createElement('script');
				tag.src = "https://www.youtube.com/iframe_api";
				var firstScriptTag = document.getElementsByTagName('script')[0];
				firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
				// This function creates an <iframe> (and YouTube player)
				// after the API code downloads.
				var player;
				var videoID = 'ln8gGDYUo-4';
				function onYouTubeIframeAPIReady() {
					player = new YT.Player('player', {
						height: '780',
						width: '1280',
						videoId: videoID,
						events: {
							'onReady': initVideo,
							'onStateChange': onPlayerStateChange

							}
						}
					);
				}
				// The API will call this function when the video player is ready.
				function onPlayerReady(event) {
					//event.target.playVideo();
				}
				function playVideo(){
					player.playVideo();
					//- startUserMedia();
				}
				function pauseVideo(){
					player.pauseVideo();
				}
				// The API calls this function when the player's state changes.
				// The function indicates that when playing a video (state=1),
				// the player should play for six seconds and then stop.
				var done = false;

				function onPlayerStateChange(event) {
					if (event.data == 2 && !done) {
						window.location.href = "#container"
						stopRecording();
					}
				}

				function stopVideo() {
					player.stopVideo();
				}

				var videoDuration; 
				
				function initVideo(){
					videoDuration = player.getDuration();

					//document.getElementById("quickStats").innerHTML = "<p>" + videoDuration + " Seconds or " + Math.floor(videoDuration / 60) + " minutes</p>";
				}
				function startSnapperTurtle(){
					//setInterval(function(){ 
						snapshotGrab();
					    //code goes here that will be run every 5 seconds.    
					//}, 1000000);
				}

	body
		.container#container(style='width: 350px')
			.page-header
				h1(align='center')
					//- object(width='70px', height='70px', type='image/svg+xml', data='archive12.svg')
					//- |           
					p  Smileish
					#replace_me
			.col-md-6
				video#v(autoplay='', style="height:1px; width: 1px;")
			.col-md-6
				img(src='', style="height: 1px; width: 1px;")
				canvas(style='display:none;')

		.row
			.col-md-12
				#player
			.col-md-12
				button(type='button', onclick="startSnapperTurtle()") Play Video!


		//-#quickStats



		script.
			var embedding = ZiggeoApi.Embed.embed("#replace_me", {paramx: "value-x", paramy: "value-y", width:"320px", height:"200px"});
			function startRecoding(){
				embedding.record(); 
			}
			function stopRecording(){
				embedding.stopRecord();
			}
			ZiggeoApi.Events.on("submitted", function (data) {
				console.log(ZiggeoApi.Videos.source());
			});
			ZiggeoApi.Events.on("ready_to_record", function (data) {
				embedding.record();
				window.location.href="#player";
				setTimeout(function() { playVideo(); }, 3000);
				startUserMedia();

				// Triggered when a video recorder is ready to record a video 
			});
			ZiggeoApi.Events.on("stop", function (data) {
				stopVideo();
				// Triggered when a playing video is stopped 
			});

			ZiggeoApi.Events.on("submitted", function (data) {
				// Triggered when a video has been recorded 
				console.log("here is ze data: ");
				console.log(data);
				console.log(data.video.token);
				$.get( "/api/submitVideo/"+data.video.token+"/"+videoID, function( data ) {
				  alert(data);
				});
				//console.log(ZiggeoApi.Videos.get(data.video.token))
				//window.location.href = "http://localhost:3000/";
			});


